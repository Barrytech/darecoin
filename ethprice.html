<html>

<head>
  <title>DareChain/ Live Data Example - HTML5 jQuery Chart Plugin by jqChart</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"   integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="   crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.js"></script>
  <script src="node_modules/bignumber.js/bignumber.js"></script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
   <!-- Latest compiled and minified CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
   <link type="text/css" rel="stylesheet" href="style.css" />
   <link rel="icon" href="http://cdn.onlinewebfonts.com/svg/img_453486.png" type="image/x-icon">

</head>

<body>
  <nav class="navbar navbar-fixed">
<div class="container-fluid">
    <ul class="nav navbar-nav navbar-left">
    <li><a href="#"><span><img class="img-fluid rounded-circle" src="https://i.pinimg.com/originals/7c/c7/a6/7cc7a630624d20f7797cb4c8e93c09c1.png" style="width: 25px; height: 25px;"></span></a></li>
      <li><a href="#"><span> DARE-COIN </span></a></li>
    </ul>
  </div>
  <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-5">

  <div id="container">
  <table width:"100%" id="table">

    <tr>
      <th class="labels">CoinMktPrice:</th>
      <th aligh="right" id="price" class="results">      </th>

    </tr>
    <tr>
      <th class="labels">MakerDaoPrice:</th>
      <th aligh="right" id="mkprice" class="results" style= "color: red; font-size: 20px; font-weight:bolder">      </th>

    </tr>

      <th class="labels">%Change:</th>
      <th aligh="right" id="change" class="results">      </th>

    </tr>

      <th class="labels">Daily:</th>
      <th aligh="right" id="day" class="results">      </th>

    </tr>

      <th class="labels">Weekly:</th>
      <th aligh="right" id="week" class="results">      </th>

    </tr>

      <th class="labels">Updated:</th>
      <th aligh="right" id="moment" class="results">      </th>

    </tr>

  </table>
  </div>
</div>
<!-- //this is the wallet -->
<div class="col-md-5" >
  <div class="container-fluid">
    <div class="nav navbar-nav navbar-right">
      <form>

      <label id="wallet_label">Wallet</label>
      <div>
        <a href="#"><span><img class="img-fluid rounded-circle" src="https://i.pinimg.com/originals/7c/c7/a6/7cc7a630624d20f7797cb4c8e93c09c1.png" style="width: 25px; height: 25px;"></span></a>
      <button id="bal" type="button" class="btn btn-info">Balance</button>
    </div>
    </li>
      <div></div>
        <div id="coinbase"></div>
        <div id="original"></div>
        <div id="current"></div>
        <div id="diff"></div>

      </div>

  </div>
    </div>
    <!-- code for the wallet ends here!! -->
        <div class="col-md-1"></div>
      </div>

</nav>

<div id="choose">
    <form>
      <option id="betnow" value="Choose"> Choose</option>
        <option id="betUp" value="Up"> Up</option>
        <option id="betDown" value="Down"> Down</option>
    </form>
</div>

<br> <br>




</body>
</html>

<!-- CODE GOES BELOW -->


<script>



/* global $ */
var url = "https://api.coinmarketcap.com/v1/ticker/ethereum/";
var makerDAOReaderABI = "https://raw.githubusercontent.com/makerdao/feeds/master/src/abi/readable.json";
var makerDAOAddress = "0x729D19f657BD0614b4985Cf1D82531c67569197B"; // on ethereum mainnet
var dareCoinABI = "https://raw.githubusercontent.com/Barrytech/";
var dareCoinAddress = "0xaaaa";

function getTimeFromSeconds(timeInSecs){
    // API returns in seconds, but Date needs milliseconds
    // so we multiply by 1000 to get todays date as a string
    return new Date(timeInSecs*1000).toDateString();
}

function updatePrice(){
  $.ajax(url).done(function (res) {

    // inside the function ^
    var price = res[0].price_usd;
    var change = res[0].percent_change_1h;
    var daychange = res[0].percent_change_24h;
    var weekchange = res[0].percent_change_7d;


    var dateAsString = getTimeFromSeconds(res[0].last_updated);

    $("#price").html( "<strong>" +"$ "+  price + "</strong>" );
    $("#change").html( "<strong>" + change + " %"+"</strong>" );
    $("#day").html( "<strong>" + daychange+ " %" + "</strong>" );
    $("#week").html( "<strong>" + weekchange+ " %" + "</strong>" );
    $("#moment").html( "<strong>" + dateAsString + "</strong>" );


  });

  // update every 5s
  setTimeout(updatePrice, 5000);
}

function updateBalance(){
  if(web3.eth.accounts.length < 1){
    console.log("You don't have an account yet");
     // TODO: update the DOM to tell the user that they need an account
    $('#bal').html("You don't have an account yet!");;
  } else {
    var myAccount = web3.eth.accounts[0];
    web3.eth.getBalance(myAccount, function(err, balance){
        $('#bal').html('Balance: ' + web3.fromWei(balance, 'ether') + " ETH");
      });
    }
    // update every 5s
    setTimeout(updateBalance, 5000);
}

function updateMakerDAOPrice(){
  if(web3.eth.accounts.length < 1){
    console.log("You don't have an account yet");
  } else {
    var myAccount = web3.eth.accounts[0];
    $.ajax(makerDAOReaderABI, {dataType: 'json'}).done(function(abi){
      var makerDAO = web3.eth.contract(abi).at(makerDAOAddress); // create functions from the ABI
      makerDAO.peek.call({from: myAccount}, function(error, ethResult){ // 'peek' is now a function!
        var price = web3.fromWei(web3.toDecimal(ethResult[0]), 'ether');
        $("#mkprice").html(" <strong>" + "$" + price + "</strong>");
      })
    })
  }
  // update very 10s
  setTimeout(updateMakerDAOPrice, 10000);
}


//Function connected to smart contract

function OnceClicked(){

    $("#betUp").on('click' function(){

      var hashCommit = web3.sha(1); // UP = 1
      //send to smartcontract for verification
      if(web3.eth.accounts.length < 1){
        console.log("You don't have an account yet");
      } else {
        var myAccount = web3.eth.accounts[0];
        $.ajax(dareCoinABI, {dataType: 'json'}).done(function(abi){
          var dareCoin = web3.eth.contract(abi).at(dareCoinAddress); // create functions from the ABI
          dareCoin.commit.sendTransaction( hashCommit,
                                          { from: myAccount, value: 10000000000000 ETH }
                                          , function(error, ethResult) { // 'peek' is now a function!
            // this is the result of the transaction
          })
        })
      }


}

    $("#betDown").on('click' function(){
      var hashCommit = web3.sha(0); // DOWN = 1

      //send to smartcontract for verification
      if(web3.eth.accounts.length < 1){
        console.log("You don't have an account yet");
      } else {
        var myAccount = web3.eth.accounts[0];
        $.ajax(dareCoinABI, {dataType: 'json'}).done(function(abi){
          var dareCoin = web3.eth.contract(abi).at(dareCoinAddress); // create functions from the ABI
          dareCoin.commit.sendTransaction( hashCommit,
                                          { from: myAccount, value: 10000000000000 ETH }
                                          , function(error, ethResult) { // 'peek' is now a function!
            // this is the result of the transaction
          })
        })
      }
    }
}



// this gets called when the webpage has loaded
$('document').ready(function(){
  updatePrice();
  updateBalance();
  updateMakerDAOPrice();
  //OnceClicked();
});

</script>
